{% extends "base.html" %}

{% block title %}é…ç½®ç®¡ç† - BTAUTOCHECK{% endblock %}

{% block content %}
<h2 style="margin-bottom: 2rem;">âš™ï¸ é…ç½®ç®¡ç†</h2>

<form id="configForm" method="POST">
    <div class="card">
        <div class="card-header">åŸºç¡€é…ç½®</div>
        
        <div class="form-group">
            <label>å®‰å…¨è¯„åˆ†é˜ˆå€¼</label>
            <input type="number" name="security_threshold" value="{{ config.security_threshold }}" min="0" max="100">
            <small style="color: #868e96;">ä½äºæ­¤åˆ†æ•°å°†å‘å‡ºè­¦å‘Šï¼ˆæ¨èï¼š80ï¼‰</small>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨é€šçŸ¥åŠŸèƒ½</span>
                <label class="switch">
                    <input type="checkbox" name="notification_enabled" {% if config.notification_enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">â° è‡ªåŠ¨æ£€æµ‹è°ƒåº¦å™¨</div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨è‡ªåŠ¨æ£€æµ‹</span>
                <label class="switch">
                    <input type="checkbox" name="scheduler_enabled" {% if config.scheduler.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
            <small style="color: #868e96;">å¯ç”¨åå°†æŒ‰è®¾å®šé—´éš”è‡ªåŠ¨æ£€æµ‹æ–°ç‰ˆæœ¬</small>
        </div>
        
        <div class="form-group">
            <label>æ£€æµ‹é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
            <select name="scheduler_interval" class="form-control">
                <option value="1" {% if config.scheduler.interval_hours == 1 %}selected{% endif %}>æ¯1å°æ—¶</option>
                <option value="2" {% if config.scheduler.interval_hours == 2 %}selected{% endif %}>æ¯2å°æ—¶</option>
                <option value="3" {% if config.scheduler.interval_hours == 3 %}selected{% endif %}>æ¯3å°æ—¶</option>
                <option value="6" {% if config.scheduler.interval_hours == 6 %}selected{% endif %}>æ¯6å°æ—¶</option>
                <option value="12" {% if config.scheduler.interval_hours == 12 %}selected{% endif %}>æ¯12å°æ—¶</option>
                <option value="24" {% if config.scheduler.interval_hours == 24 %}selected{% endif %}>æ¯24å°æ—¶ï¼ˆä¸€å¤©ä¸€æ¬¡ï¼‰</option>
            </select>
            <small style="color: #868e96;">å»ºè®®ï¼šç”Ÿäº§ç¯å¢ƒ1-2å°æ—¶ï¼Œæµ‹è¯•ç¯å¢ƒ6-12å°æ—¶</small>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">ğŸ“¦ GitHubä¸Šä¼ é…ç½®</div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨è‡ªåŠ¨ä¸Šä¼ </span>
                <label class="switch">
                    <input type="checkbox" name="auto_upload" {% if config.auto_upload %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
            <small style="color: #868e96;">æ£€æµ‹å®Œæˆåè‡ªåŠ¨ä¸Šä¼ æŠ¥å‘Šåˆ°GitHubä»“åº“</small>
        </div>
        
        <div class="form-group">
            <label>GitHubç”¨æˆ·å</label>
            <input type="text" name="github_username" value="{{ config.github_username }}" placeholder="your_github_username">
            <small style="color: #868e96;">ä½ çš„GitHubç”¨æˆ·å</small>
        </div>
        
        <div class="form-group">
            <label>GitHubä»“åº“å</label>
            <input type="text" name="github_repo" value="{{ config.github_repo }}" placeholder="bt-panel-files">
            <small style="color: #868e96;">å­˜æ”¾æŠ¥å‘Šçš„ä»“åº“åç§°</small>
        </div>
        
        <div class="form-group">
            <label>GitHub Token</label>
            <input type="password" name="github_token" value="{{ config.github_token }}" placeholder="ghp_xxxxxxxxxxxx">
            <small style="color: #868e96;">
                Personal Access Tokenï¼Œéœ€è¦repoæƒé™ 
                <a href="https://github.com/settings/tokens" target="_blank" style="color: #667eea;">è·å–Token â†’</a>
            </small>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">å¤‡ä»½é…ç½®</div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨å¤‡ä»½åŠŸèƒ½</span>
                <label class="switch">
                    <input type="checkbox" name="backup_enabled" {% if config.backup_enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å‡çº§å‰è‡ªåŠ¨å¤‡ä»½</span>
                <label class="switch">
                    <input type="checkbox" name="backup_before_upgrade" {% if config.backup_before_upgrade %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š</span>
                <label class="switch">
                    <input type="checkbox" name="auto_rollback_on_failure" {% if config.auto_rollback_on_failure %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
        </div>
        
        <div class="form-group">
            <label>ä¿ç•™å¤‡ä»½æ•°é‡</label>
            <input type="number" name="keep_backups" value="{{ config.keep_backups }}" min="1" max="20">
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">ğŸ¤– AIæ·±åº¦åˆ†æé…ç½®</div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨AIåˆ†æ</span>
                <label class="switch">
                    <input type="checkbox" name="ai_enabled" {% if config.ai_providers.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
            <small style="color: #868e96;">å¯ç”¨åå°†ä½¿ç”¨AIè¿›è¡Œæ·±åº¦ä»£ç åˆ†æï¼ˆæ›´å‡†ç¡®ï¼Œä½†è€—æ—¶ç¨é•¿ï¼‰</small>
        </div>
        
        <div class="form-group">
            <label>ä¸»è¦AIæ¨¡å‹</label>
            <select name="primary_provider" class="form-control">
                <option value="gemini" {% if config.ai_providers.primary_provider == 'gemini' %}selected{% endif %}>Google Geminiï¼ˆæ¨è-å…è´¹ï¼‰</option>
                <option value="openai" {% if config.ai_providers.primary_provider == 'openai' %}selected{% endif %}>OpenAI GPT-4</option>
                <option value="claude" {% if config.ai_providers.primary_provider == 'claude' %}selected{% endif %}>Claude (Anthropic)</option>
                <option value="qianwen" {% if config.ai_providers.primary_provider == 'qianwen' %}selected{% endif %}>é€šä¹‰åƒé—®ï¼ˆé˜¿é‡Œäº‘ï¼‰</option>
                <option value="wenxin" {% if config.ai_providers.primary_provider == 'wenxin' %}selected{% endif %}>æ–‡å¿ƒä¸€è¨€ï¼ˆç™¾åº¦ï¼‰</option>
                <option value="zhipu" {% if config.ai_providers.primary_provider == 'zhipu' %}selected{% endif %}>æ™ºè°±GLM</option>
                <option value="deepseek" {% if config.ai_providers.primary_provider == 'deepseek' %}selected{% endif %}>DeepSeek</option>
                <option value="kimi" {% if config.ai_providers.primary_provider == 'kimi' %}selected{% endif %}>Kimiï¼ˆæœˆä¹‹æš—é¢ï¼‰</option>
                <option value="grok" {% if config.ai_providers.primary_provider == 'grok' %}selected{% endif %}>Grok (xAI)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨å¤‡ç”¨åˆ‡æ¢</span>
                <label class="switch">
                    <input type="checkbox" name="fallback_enabled" {% if config.ai_providers.fallback_enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
            <small style="color: #868e96;">ä¸»AIä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–å·²å¯ç”¨çš„AI</small>
        </div>
        
        <hr style="margin: 2rem 0;">
        
        <h4 style="margin-bottom: 1rem; color: #667eea;">ğŸ”‘ API Key é…ç½®</h4>
        
        <div class="form-group">
            <label>Gemini API Key</label>
            <input type="text" name="gemini_api_key" value="{{ config.ai_providers.gemini.api_key if config.ai_providers.gemini.api_key != 'YOUR_GEMINI_API_KEY' else '' }}" placeholder="ä» https://aistudio.google.com/app/apikey è·å–">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="gemini_enabled" {% if config.ai_providers.gemini.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨Gemini</small>
        </div>
        
        <div class="form-group">
            <label>OpenAI API Key</label>
            <input type="text" name="openai_api_key" value="{{ config.ai_providers.openai.api_key if config.ai_providers.openai.api_key and not config.ai_providers.openai.api_key.startswith('YOUR_') else '' }}" placeholder="sk-proj-...">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="openai_enabled" {% if config.ai_providers.openai.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨OpenAI</small>
        </div>
        
        <div class="form-group">
            <label>Claude API Key</label>
            <input type="text" name="claude_api_key" value="{{ config.ai_providers.claude.api_key if config.ai_providers.claude.api_key and not config.ai_providers.claude.api_key.startswith('YOUR_') else '' }}" placeholder="sk-ant-...">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="claude_enabled" {% if config.ai_providers.claude.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨Claude</small>
        </div>
        
        <div class="form-group">
            <label>é€šä¹‰åƒé—® API Key</label>
            <input type="text" name="qianwen_api_key" value="{{ config.ai_providers.qianwen.api_key if config.ai_providers.qianwen.api_key and not config.ai_providers.qianwen.api_key.startswith('YOUR_') else '' }}" placeholder="sk-...">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="qianwen_enabled" {% if config.ai_providers.qianwen.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨é€šä¹‰åƒé—®</small>
        </div>
        
        <div class="form-group">
            <label>Grok API Key</label>
            <input type="text" name="grok_api_key" value="{{ config.ai_providers.grok.api_key if config.ai_providers.grok.api_key and not config.ai_providers.grok.api_key.startswith('YOUR_') else '' }}" placeholder="xai-...">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="grok_enabled" {% if config.ai_providers.grok.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨Grok (xAI)</small>
        </div>
        
        <div class="form-group">
            <label>æ–‡å¿ƒä¸€è¨€ API Key</label>
            <input type="text" name="wenxin_api_key" value="{{ config.ai_providers.wenxin.api_key if config.ai_providers.wenxin.api_key and not config.ai_providers.wenxin.api_key.startswith('YOUR_') else '' }}" placeholder="ç™¾åº¦æ–‡å¿ƒAPI Key">
            <input type="text" name="wenxin_secret_key" value="{{ config.ai_providers.wenxin.secret_key if config.ai_providers.wenxin.secret_key and not config.ai_providers.wenxin.secret_key.startswith('YOUR_') else '' }}" placeholder="Secret Key" style="margin-top: 0.5rem;">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="wenxin_enabled" {% if config.ai_providers.wenxin.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨æ–‡å¿ƒä¸€è¨€</small>
        </div>
        
        <div class="form-group">
            <label>æ™ºè°±GLM API Key</label>
            <input type="text" name="zhipu_api_key" value="{{ config.ai_providers.zhipu.api_key if config.ai_providers.zhipu.api_key and not config.ai_providers.zhipu.api_key.startswith('YOUR_') else '' }}" placeholder="YOUR_API_KEY.xxx">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="zhipu_enabled" {% if config.ai_providers.zhipu.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨æ™ºè°±GLM</small>
        </div>
        
        <div class="form-group">
            <label>DeepSeek API Key</label>
            <input type="text" name="deepseek_api_key" value="{{ config.ai_providers.deepseek.api_key if config.ai_providers.deepseek.api_key and not config.ai_providers.deepseek.api_key.startswith('YOUR_') else '' }}" placeholder="sk-...">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="deepseek_enabled" {% if config.ai_providers.deepseek.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨DeepSeek</small>
        </div>
        
        <div class="form-group">
            <label>Kimi API Key</label>
            <input type="text" name="kimi_api_key" value="{{ config.ai_providers.kimi.api_key if config.ai_providers.kimi.api_key and not config.ai_providers.kimi.api_key.startswith('YOUR_') else '' }}" placeholder="sk-...">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="kimi_enabled" {% if config.ai_providers.kimi.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨Kimiï¼ˆæœˆä¹‹æš—é¢ï¼‰</small>
        </div>
        
        <div class="form-group">
            <label>è®¯é£æ˜Ÿç« é…ç½®</label>
            <input type="text" name="xunfei_app_id" value="{{ config.ai_providers.xunfei.app_id if config.ai_providers.xunfei.app_id and not config.ai_providers.xunfei.app_id.startswith('YOUR_') else '' }}" placeholder="App ID" style="margin-bottom: 0.5rem;">
            <input type="text" name="xunfei_api_key" value="{{ config.ai_providers.xunfei.api_key if config.ai_providers.xunfei.api_key and not config.ai_providers.xunfei.api_key.startswith('YOUR_') else '' }}" placeholder="API Key" style="margin-bottom: 0.5rem;">
            <input type="text" name="xunfei_api_secret" value="{{ config.ai_providers.xunfei.api_secret if config.ai_providers.xunfei.api_secret and not config.ai_providers.xunfei.api_secret.startswith('YOUR_') else '' }}" placeholder="API Secret">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="xunfei_enabled" {% if config.ai_providers.xunfei.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨è®¯é£æ˜Ÿç«ï¼ˆéœ€WebSocketæ”¯æŒï¼‰</small>
        </div>
        
        <p style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 5px; color: #495057; font-size: 0.9rem;">
            ğŸ’¡ <b>æç¤º</b>: å„AIæ¨¡å‹çš„API Keyè·å–æ–¹æ³•è¯·æŸ¥çœ‹ <a href="https://github.com/GSDPGIT/BTAUTOCHECK/blob/main/AI_SETUP_GUIDE.md" target="_blank" style="color: #667eea;">AIé…ç½®æŒ‡å—</a>
        </p>
    </div>
    
    <div class="card">
        <div class="card-header">Serveré…±é€šçŸ¥</div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨Serveré…±</span>
                <label class="switch">
                    <input type="checkbox" name="serverchan_enabled" {% if config.notifications.serverchan.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
        </div>
        
        <div class="form-group">
            <label>SendKey</label>
            <input type="text" name="serverchan_sendkey" value="{{ config.notifications.serverchan.sendkey }}" placeholder="SCT...">
            <small style="color: #868e96;">ä» https://sct.ftqq.com/ è·å–</small>
        </div>
    </div>
    
    <div style="display: flex; gap: 1rem;">
        <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
        <button type="button" onclick="testNotification()" class="btn btn-success">ğŸ“¨ æµ‹è¯•é€šçŸ¥</button>
        <button type="button" onclick="testAI(event)" class="btn btn-secondary">ğŸ¤– æµ‹è¯•AI</button>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('configForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{{ url_for("config_management") }}', {
        method: 'POST',
        body: new URLSearchParams(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ' + data.message);
            location.reload();
        } else {
            alert('âŒ ' + (data.message || 'ä¿å­˜å¤±è´¥'));
        }
    })
    .catch(error => {
        alert('âŒ ä¿å­˜å¤±è´¥: ' + error);
    });
});

function testNotification() {
    ajaxPost('{{ url_for("test_notification") }}', {}, function(data) {
        if (data.success) {
            alert('âœ… ' + data.message);
        } else {
            alert('âŒ ' + data.message);
        }
    });
}

function testAI(event) {
    if (!confirm('ç¡®å®šè¦æµ‹è¯•AIè¿æ¥å—ï¼Ÿ\nè¿™å°†è°ƒç”¨å·²é…ç½®çš„AIè¿›è¡Œæµ‹è¯•åˆ†æã€‚')) {
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½ä¸­
    const btn = event ? event.target : null;
    const originalText = btn ? btn.textContent : '';
    
    if (btn) {
        btn.textContent = 'æµ‹è¯•ä¸­...';
        btn.disabled = true;
    }
    
    ajaxPost('{{ url_for("test_ai") }}', {}, function(data) {
        if (btn) {
            btn.textContent = originalText;
            btn.disabled = false;
        }
        
        if (data.success) {
            alert(data.message);
        } else {
            alert('âŒ ' + data.message);
        }
    });
}
</script>
{% endblock %}


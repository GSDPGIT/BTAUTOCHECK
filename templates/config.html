{% extends "base.html" %}

{% block title %}é…ç½®ç®¡ç† - BTAUTOCHECK{% endblock %}

{% block content %}
<h2 style="margin-bottom: 2rem;">âš™ï¸ é…ç½®ç®¡ç†</h2>

<form id="configForm" method="POST">
    <div class="card">
        <div class="card-header">åŸºç¡€é…ç½®</div>
        
        <div class="form-group">
            <label>å®‰å…¨è¯„åˆ†é˜ˆå€¼</label>
            <input type="number" name="security_threshold" value="{{ config.security_threshold }}" min="0" max="100">
            <small style="color: #868e96;">ä½äºæ­¤åˆ†æ•°å°†å‘å‡ºè­¦å‘Šï¼ˆæ¨èï¼š80ï¼‰</small>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨é€šçŸ¥åŠŸèƒ½</span>
                <label class="switch">
                    <input type="checkbox" name="notification_enabled" {% if config.notification_enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">å¤‡ä»½é…ç½®</div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨å¤‡ä»½åŠŸèƒ½</span>
                <label class="switch">
                    <input type="checkbox" name="backup_enabled" {% if config.backup_enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å‡çº§å‰è‡ªåŠ¨å¤‡ä»½</span>
                <label class="switch">
                    <input type="checkbox" name="backup_before_upgrade" {% if config.backup_before_upgrade %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š</span>
                <label class="switch">
                    <input type="checkbox" name="auto_rollback_on_failure" {% if config.auto_rollback_on_failure %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
        </div>
        
        <div class="form-group">
            <label>ä¿ç•™å¤‡ä»½æ•°é‡</label>
            <input type="number" name="keep_backups" value="{{ config.keep_backups }}" min="1" max="20">
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">ğŸ¤– AIæ·±åº¦åˆ†æé…ç½®</div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨AIåˆ†æ</span>
                <label class="switch">
                    <input type="checkbox" name="ai_enabled" {% if config.ai_providers.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
            <small style="color: #868e96;">å¯ç”¨åå°†ä½¿ç”¨AIè¿›è¡Œæ·±åº¦ä»£ç åˆ†æï¼ˆæ›´å‡†ç¡®ï¼Œä½†è€—æ—¶ç¨é•¿ï¼‰</small>
        </div>
        
        <div class="form-group">
            <label>ä¸»è¦AIæ¨¡å‹</label>
            <select name="primary_provider" class="form-control">
                <option value="gemini" {% if config.ai_providers.primary_provider == 'gemini' %}selected{% endif %}>Google Geminiï¼ˆæ¨è-å…è´¹ï¼‰</option>
                <option value="openai" {% if config.ai_providers.primary_provider == 'openai' %}selected{% endif %}>OpenAI GPT-4</option>
                <option value="claude" {% if config.ai_providers.primary_provider == 'claude' %}selected{% endif %}>Claude (Anthropic)</option>
                <option value="qianwen" {% if config.ai_providers.primary_provider == 'qianwen' %}selected{% endif %}>é€šä¹‰åƒé—®ï¼ˆé˜¿é‡Œäº‘ï¼‰</option>
                <option value="wenxin" {% if config.ai_providers.primary_provider == 'wenxin' %}selected{% endif %}>æ–‡å¿ƒä¸€è¨€ï¼ˆç™¾åº¦ï¼‰</option>
                <option value="zhipu" {% if config.ai_providers.primary_provider == 'zhipu' %}selected{% endif %}>æ™ºè°±GLM</option>
                <option value="deepseek" {% if config.ai_providers.primary_provider == 'deepseek' %}selected{% endif %}>DeepSeek</option>
                <option value="kimi" {% if config.ai_providers.primary_provider == 'kimi' %}selected{% endif %}>Kimiï¼ˆæœˆä¹‹æš—é¢ï¼‰</option>
                <option value="grok" {% if config.ai_providers.primary_provider == 'grok' %}selected{% endif %}>Grok (xAI)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨å¤‡ç”¨åˆ‡æ¢</span>
                <label class="switch">
                    <input type="checkbox" name="fallback_enabled" {% if config.ai_providers.fallback_enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
            <small style="color: #868e96;">ä¸»AIä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–å·²å¯ç”¨çš„AI</small>
        </div>
        
        <hr style="margin: 2rem 0;">
        
        <h4 style="margin-bottom: 1rem; color: #667eea;">ğŸ”‘ API Key é…ç½®</h4>
        
        <div class="form-group">
            <label>Gemini API Key</label>
            <input type="text" name="gemini_api_key" value="{{ config.ai_providers.gemini.api_key if config.ai_providers.gemini.api_key != 'YOUR_GEMINI_API_KEY' else '' }}" placeholder="ä» https://aistudio.google.com/app/apikey è·å–">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="gemini_enabled" {% if config.ai_providers.gemini.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨Gemini</small>
        </div>
        
        <div class="form-group">
            <label>OpenAI API Key</label>
            <input type="text" name="openai_api_key" value="{{ config.ai_providers.openai.api_key if config.ai_providers.openai.api_key and not config.ai_providers.openai.api_key.startswith('YOUR_') else '' }}" placeholder="sk-proj-...">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="openai_enabled" {% if config.ai_providers.openai.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨OpenAI</small>
        </div>
        
        <div class="form-group">
            <label>Claude API Key</label>
            <input type="text" name="claude_api_key" value="{{ config.ai_providers.claude.api_key if config.ai_providers.claude.api_key and not config.ai_providers.claude.api_key.startswith('YOUR_') else '' }}" placeholder="sk-ant-...">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="claude_enabled" {% if config.ai_providers.claude.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨Claude</small>
        </div>
        
        <div class="form-group">
            <label>é€šä¹‰åƒé—® API Key</label>
            <input type="text" name="qianwen_api_key" value="{{ config.ai_providers.qianwen.api_key if config.ai_providers.qianwen.api_key and not config.ai_providers.qianwen.api_key.startswith('YOUR_') else '' }}" placeholder="sk-...">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="qianwen_enabled" {% if config.ai_providers.qianwen.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨é€šä¹‰åƒé—®</small>
        </div>
        
        <div class="form-group">
            <label>Grok API Key</label>
            <input type="text" name="grok_api_key" value="{{ config.ai_providers.grok.api_key if config.ai_providers.grok.api_key and not config.ai_providers.grok.api_key.startswith('YOUR_') else '' }}" placeholder="xai-...">
            <label class="switch" style="margin-top: 0.5rem;">
                <input type="checkbox" name="grok_enabled" {% if config.ai_providers.grok.enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
            <small style="margin-left: 0.5rem;">å¯ç”¨Grok (xAI)</small>
        </div>
        
        <p style="margin-top: 1rem; color: #868e96; font-size: 0.9rem;">
            ğŸ’¡ æ›´å¤šAIé…ç½®ï¼ˆDeepSeekã€Kimiã€æ–‡å¿ƒä¸€è¨€ç­‰ï¼‰è¯·ç›´æ¥ç¼–è¾‘ config.json æˆ–æŸ¥çœ‹ <a href="https://github.com/GSDPGIT/BTAUTOCHECK/blob/main/AI_SETUP_GUIDE.md" target="_blank" style="color: #667eea;">AIé…ç½®æŒ‡å—</a>
        </p>
    </div>
    
    <div class="card">
        <div class="card-header">Serveré…±é€šçŸ¥</div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 1rem;">
                <span>å¯ç”¨Serveré…±</span>
                <label class="switch">
                    <input type="checkbox" name="serverchan_enabled" {% if config.notifications.serverchan.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </label>
        </div>
        
        <div class="form-group">
            <label>SendKey</label>
            <input type="text" name="serverchan_sendkey" value="{{ config.notifications.serverchan.sendkey }}" placeholder="SCT...">
            <small style="color: #868e96;">ä» https://sct.ftqq.com/ è·å–</small>
        </div>
    </div>
    
    <div style="display: flex; gap: 1rem;">
        <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
        <button type="button" onclick="testNotification()" class="btn btn-success">ğŸ“¨ æµ‹è¯•é€šçŸ¥</button>
        <button type="button" onclick="testAI()" class="btn btn-secondary">ğŸ¤– æµ‹è¯•AI</button>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('configForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{{ url_for("config_management") }}', {
        method: 'POST',
        body: new URLSearchParams(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ' + data.message);
            location.reload();
        } else {
            alert('âŒ ' + (data.message || 'ä¿å­˜å¤±è´¥'));
        }
    })
    .catch(error => {
        alert('âŒ ä¿å­˜å¤±è´¥: ' + error);
    });
});

function testNotification() {
    ajaxPost('{{ url_for("test_notification") }}', {}, function(data) {
        if (data.success) {
            alert('âœ… ' + data.message);
        } else {
            alert('âŒ ' + data.message);
        }
    });
}

function testAI() {
    if (!confirm('ç¡®å®šè¦æµ‹è¯•AIè¿æ¥å—ï¼Ÿ\nè¿™å°†è°ƒç”¨å·²é…ç½®çš„AIè¿›è¡Œæµ‹è¯•åˆ†æã€‚')) {
        return;
    }
    
    alert('ğŸ§ª AIæµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...\n\nè¯·ä½¿ç”¨å‘½ä»¤è¡Œæµ‹è¯•ï¼š\npython3 ai_analyzer.py test');
}
</script>
{% endblock %}


{% extends "base.html" %}

{% block title %}å‘Šè­¦è§„åˆ™ - BTAUTOCHECK{% endblock %}

{% block extra_css %}
<style>
.checkbox-item {
    display: block;
    margin-bottom: 10px;
    cursor: pointer;
    padding: 8px 0;
}

.checkbox-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
    vertical-align: middle;
    margin: 0 8px 0 0;
    position: relative;
    top: -1px;
}

.checkbox-item span {
    vertical-align: middle;
    line-height: 16px;
}
</style>
{% endblock %}

{% block content %}
<h2 style="margin-bottom: 2rem;">ğŸ”” æ™ºèƒ½å‘Šè­¦è§„åˆ™é…ç½®</h2>

<form id="alertRulesForm" method="POST">
    <!-- ä¸¥é‡å‘Šè­¦ -->
    <div class="card">
        <div class="card-header" style="background: #ff6b6b; color: white;">
            ğŸ”´ ä¸¥é‡å‘Šè­¦ï¼ˆCriticalï¼‰
        </div>

        <div class="form-group">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-weight: 500; color: #495057;">å¯ç”¨ä¸¥é‡å‘Šè­¦</span>
                <label class="switch">
                    <input type="checkbox" name="critical_enabled" {% if config.alert_rules.critical.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </div>
            <small style="color: #868e96;">è§¦å‘æ¡ä»¶ï¼šè¯„åˆ†è¿‡ä½æˆ–å‘ç°åé—¨ä»£ç </small>
        </div>

        <div class="form-group">
            <label>è¯„åˆ†é˜ˆå€¼ï¼ˆä½äºæ­¤åˆ†æ•°è§¦å‘ï¼‰</label>
            <input type="number" name="critical_score_threshold" value="{{ config.alert_rules.critical.score_threshold }}" min="0" max="100">
            <small style="color: #868e96;">æ¨èï¼š60åˆ†</small>
        </div>

        <div class="form-group">
            <label>é«˜é£é™©æ–‡ä»¶é˜ˆå€¼</label>
            <input type="number" name="critical_high_risk_threshold" value="{{ config.alert_rules.critical.high_risk_threshold }}" min="0" max="1000">
            <small style="color: #868e96;">é£é™©æ–‡ä»¶æ•°è¶…è¿‡æ­¤å€¼æ—¶è§¦å‘å‘Šè­¦</small>
        </div>

        <div class="form-group">
            <label style="margin-bottom: 0.75rem;">è§¦å‘æ¡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰</label>
            <label class="checkbox-item">
                <input type="checkbox" name="critical_conditions" value="score_critical" {% if 'score_critical' in config.alert_rules.critical.conditions %}checked{% endif %}>
                <span>è¯„åˆ†è¿‡ä½ï¼ˆä½äºä¸Šè¿°é˜ˆå€¼ï¼‰</span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="critical_conditions" value="backdoor_found" {% if 'backdoor_found' in config.alert_rules.critical.conditions %}checked{% endif %}>
                <span>å‘ç°åé—¨ä»£ç </span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="critical_conditions" value="high_risk_files" {% if 'high_risk_files' in config.alert_rules.critical.conditions %}checked{% endif %}>
                <span>é«˜é£é™©æ–‡ä»¶è¿‡å¤š</span>
            </label>
        </div>

        <div class="form-group">
            <label>é‡å¤é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
            <input type="number" name="critical_repeat_interval" value="{{ config.alert_rules.critical.repeat_interval_hours }}" min="1" max="168">
            <small style="color: #868e96;">åŒä¸€é—®é¢˜åœ¨æ­¤æ—¶é—´å†…ä¸é‡å¤å‘Šè­¦ï¼ˆæ¨èï¼š24å°æ—¶ï¼‰</small>
        </div>

        <div class="form-group">
            <label style="margin-bottom: 0.75rem;">é€šçŸ¥æ¸ é“ï¼ˆå¯å¤šé€‰ï¼‰</label>
            <label class="checkbox-item">
                <input type="checkbox" name="critical_channels" value="email" {% if 'email' in config.alert_rules.critical.channels %}checked{% endif %}>
                <span>é‚®ä»¶</span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="critical_channels" value="serverchan" {% if 'serverchan' in config.alert_rules.critical.channels %}checked{% endif %}>
                <span>Serveré…±ï¼ˆå¾®ä¿¡ï¼‰</span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="critical_channels" value="telegram" {% if 'telegram' in config.alert_rules.critical.channels %}checked{% endif %}>
                <span>Telegram</span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="critical_channels" value="webhook" {% if 'webhook' in config.alert_rules.critical.channels %}checked{% endif %}>
                <span>Webhook</span>
            </label>
        </div>
    </div>

    <!-- è­¦å‘Šå‘Šè­¦ -->
    <div class="card">
        <div class="card-header" style="background: #f59f00; color: white;">
            âš ï¸ è­¦å‘Šå‘Šè­¦ï¼ˆWarningï¼‰
        </div>

        <div class="form-group">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-weight: 500; color: #495057;">å¯ç”¨è­¦å‘Šå‘Šè­¦</span>
                <label class="switch">
                    <input type="checkbox" name="warning_enabled" {% if config.alert_rules.warning.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>è¯„åˆ†é˜ˆå€¼</label>
            <input type="number" name="warning_score_threshold" value="{{ config.alert_rules.warning.score_threshold }}" min="60" max="100">
            <small style="color: #868e96;">æ¨èï¼š75åˆ†</small>
        </div>

        <div class="form-group">
            <label>é‡å¤é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
            <input type="number" name="warning_repeat_interval" value="{{ config.alert_rules.warning.repeat_interval_hours }}" min="1" max="168">
            <small style="color: #868e96;">æ¨èï¼š72å°æ—¶ï¼ˆ3å¤©ï¼‰</small>
        </div>

        <div class="form-group">
            <label style="margin-bottom: 0.75rem;">é€šçŸ¥æ¸ é“</label>
            <label class="checkbox-item">
                <input type="checkbox" name="warning_channels" value="email" {% if 'email' in config.alert_rules.warning.channels %}checked{% endif %}>
                <span>é‚®ä»¶</span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="warning_channels" value="serverchan" {% if 'serverchan' in config.alert_rules.warning.channels %}checked{% endif %}>
                <span>Serveré…±ï¼ˆå¾®ä¿¡ï¼‰</span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="warning_channels" value="telegram" {% if 'telegram' in config.alert_rules.warning.channels %}checked{% endif %}>
                <span>Telegram</span>
            </label>
        </div>
    </div>

    <!-- ä¿¡æ¯é€šçŸ¥ -->
    <div class="card">
        <div class="card-header" style="background: #339af0; color: white;">
            ğŸ“¢ ä¿¡æ¯é€šçŸ¥ï¼ˆInfoï¼‰
        </div>

        <div class="form-group">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-weight: 500; color: #495057;">å¯ç”¨ä¿¡æ¯é€šçŸ¥</span>
                <label class="switch">
                    <input type="checkbox" name="info_enabled" {% if config.alert_rules.info.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </div>
            <small style="color: #868e96;">å‘ç°æ–°ç‰ˆæœ¬æ—¶é€šçŸ¥</small>
        </div>

        <div class="form-group">
            <label>é‡å¤é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
            <input type="number" name="info_repeat_interval" value="{{ config.alert_rules.info.repeat_interval_hours }}" min="1" max="720">
            <small style="color: #868e96;">æ¨èï¼š168å°æ—¶ï¼ˆ1å‘¨ï¼‰</small>
        </div>

        <div class="form-group">
            <label style="margin-bottom: 0.75rem;">é€šçŸ¥æ¸ é“</label>
            <label class="checkbox-item">
                <input type="checkbox" name="info_channels" value="serverchan" {% if 'serverchan' in config.alert_rules.info.channels %}checked{% endif %}>
                <span>Serveré…±ï¼ˆå¾®ä¿¡ï¼‰</span>
            </label>
            <label class="checkbox-item">
                <input type="checkbox" name="info_channels" value="webhook" {% if 'webhook' in config.alert_rules.info.channels %}checked{% endif %}>
                <span>Webhook</span>
            </label>
        </div>
    </div>

    <!-- é™é»˜æ—¶é—´ -->
    <div class="card">
        <div class="card-header">
            ğŸŒ™ é™é»˜æ—¶é—´ï¼ˆDo Not Disturbï¼‰
        </div>

        <div class="form-group">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-weight: 500; color: #495057;">å¯ç”¨é™é»˜æ—¶é—´</span>
                <label class="switch">
                    <input type="checkbox" name="silent_hours_enabled" {% if config.alert_rules.silent_hours.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </div>
            <small style="color: #868e96;">åœ¨æŒ‡å®šæ—¶é—´æ®µå†…ä¸å‘é€å‘Šè­¦ï¼ˆé¿å…å¤œé—´æ‰“æ‰°ï¼‰</small>
        </div>

        <div class="form-group">
            <label>å¼€å§‹æ—¶é—´</label>
            <input type="time" name="silent_start" value="{{ config.alert_rules.silent_hours.start }}">
        </div>

        <div class="form-group">
            <label>ç»“æŸæ—¶é—´</label>
            <input type="time" name="silent_end" value="{{ config.alert_rules.silent_hours.end }}">
            <small style="color: #868e96;">ä¾‹å¦‚ï¼š22:00 åˆ° 08:00ï¼ˆå¤œé—´é™é»˜ï¼‰</small>
        </div>
    </div>

    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜å‘Šè­¦è§„åˆ™</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">â† è¿”å›ä»ªè¡¨æ¿</a>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('alertRulesForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    ajaxPost('{{ url_for("alert_rules_config") }}', Object.fromEntries(formData), function(data) {
        if (data.success) {
            alert('âœ… ' + data.message);
            setTimeout(function() {
                window.location.reload();
            }, 1000);
        } else {
            alert('âŒ ' + data.message);
        }
    });
});
</script>
{% endblock %}

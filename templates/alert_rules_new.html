{% extends "base_new.html" %}

{% block title %}告警规则 - BTAUTOCHECK{% endblock %}

{% block content %}
<h2 style="margin-bottom: 2rem; font-size: 1.875rem; font-weight: 700; color: var(--gray-900);">
    🔔 智能告警规则配置
</h2>

<form id="alertRulesForm" method="POST">
    <!-- 严重告警 -->
    <div class="card">
        <div class="card-header" style="color: var(--danger); border-color: #fecaca;">
            🔴 严重告警（Critical）
        </div>

        <div class="form-group">
            <div class="toggle-wrapper">
                <span class="toggle-label">启用严重告警</span>
                <label class="switch">
                    <input type="checkbox" name="critical_enabled" {% if config.alert_rules.critical.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </div>
            <small class="form-hint">触发条件：评分过低或发现后门代码</small>
        </div>

        <div class="form-group">
            <label class="form-label">评分阈值（低于此分数触发）</label>
            <input type="number" class="form-input" name="critical_score_threshold" value="{{ config.alert_rules.critical.score_threshold }}" min="0" max="100">
            <small class="form-hint">推荐：60分</small>
        </div>

        <div class="form-group">
            <label class="form-label">高风险文件阈值</label>
            <input type="number" class="form-input" name="critical_high_risk_threshold" value="{{ config.alert_rules.critical.high_risk_threshold }}" min="0" max="1000">
            <small class="form-hint">风险文件数超过此值时触发告警</small>
        </div>

        <div class="form-group">
            <label class="form-label">触发条件（可多选）</label>
            <div class="checkbox-group">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="critical_cond_1" name="critical_conditions" value="score_critical" {% if 'score_critical' in config.alert_rules.critical.conditions %}checked{% endif %}>
                    <label for="critical_cond_1">评分过低（低于上述阈值）</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="critical_cond_2" name="critical_conditions" value="backdoor_found" {% if 'backdoor_found' in config.alert_rules.critical.conditions %}checked{% endif %}>
                    <label for="critical_cond_2">发现后门代码</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="critical_cond_3" name="critical_conditions" value="high_risk_files" {% if 'high_risk_files' in config.alert_rules.critical.conditions %}checked{% endif %}>
                    <label for="critical_cond_3">高风险文件过多</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">重复间隔（小时）</label>
            <input type="number" class="form-input" name="critical_repeat_interval" value="{{ config.alert_rules.critical.repeat_interval_hours }}" min="1" max="168">
            <small class="form-hint">同一问题在此时间内不重复告警（推荐：24小时）</small>
        </div>

        <div class="form-group">
            <label class="form-label">通知渠道（可多选）</label>
            <div class="checkbox-group">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="critical_ch_1" name="critical_channels" value="email" {% if 'email' in config.alert_rules.critical.channels %}checked{% endif %}>
                    <label for="critical_ch_1">邮件</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="critical_ch_2" name="critical_channels" value="serverchan" {% if 'serverchan' in config.alert_rules.critical.channels %}checked{% endif %}>
                    <label for="critical_ch_2">Server酱（微信）</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="critical_ch_3" name="critical_channels" value="telegram" {% if 'telegram' in config.alert_rules.critical.channels %}checked{% endif %}>
                    <label for="critical_ch_3">Telegram</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="critical_ch_4" name="critical_channels" value="webhook" {% if 'webhook' in config.alert_rules.critical.channels %}checked{% endif %}>
                    <label for="critical_ch_4">Webhook</label>
                </div>
            </div>
        </div>
    </div>

    <!-- 警告告警 -->
    <div class="card">
        <div class="card-header" style="color: var(--warning); border-color: #fde68a;">
            ⚠️ 警告告警（Warning）
        </div>

        <div class="form-group">
            <div class="toggle-wrapper">
                <span class="toggle-label">启用警告告警</span>
                <label class="switch">
                    <input type="checkbox" name="warning_enabled" {% if config.alert_rules.warning.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">评分阈值</label>
            <input type="number" class="form-input" name="warning_score_threshold" value="{{ config.alert_rules.warning.score_threshold }}" min="60" max="100">
            <small class="form-hint">推荐：75分</small>
        </div>

        <div class="form-group">
            <label class="form-label">重复间隔（小时）</label>
            <input type="number" class="form-input" name="warning_repeat_interval" value="{{ config.alert_rules.warning.repeat_interval_hours }}" min="1" max="168">
            <small class="form-hint">推荐：72小时（3天）</small>
        </div>

        <div class="form-group">
            <label class="form-label">通知渠道</label>
            <div class="checkbox-group">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="warning_ch_1" name="warning_channels" value="email" {% if 'email' in config.alert_rules.warning.channels %}checked{% endif %}>
                    <label for="warning_ch_1">邮件</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="warning_ch_2" name="warning_channels" value="serverchan" {% if 'serverchan' in config.alert_rules.warning.channels %}checked{% endif %}>
                    <label for="warning_ch_2">Server酱（微信）</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="warning_ch_3" name="warning_channels" value="telegram" {% if 'telegram' in config.alert_rules.warning.channels %}checked{% endif %}>
                    <label for="warning_ch_3">Telegram</label>
                </div>
            </div>
        </div>
    </div>

    <!-- 信息通知 -->
    <div class="card">
        <div class="card-header" style="color: var(--info); border-color: #bfdbfe;">
            📢 信息通知（Info）
        </div>

        <div class="form-group">
            <div class="toggle-wrapper">
                <span class="toggle-label">启用信息通知</span>
                <label class="switch">
                    <input type="checkbox" name="info_enabled" {% if config.alert_rules.info.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </div>
            <small class="form-hint">发现新版本时通知</small>
        </div>

        <div class="form-group">
            <label class="form-label">重复间隔（小时）</label>
            <input type="number" class="form-input" name="info_repeat_interval" value="{{ config.alert_rules.info.repeat_interval_hours }}" min="1" max="720">
            <small class="form-hint">推荐：168小时（1周）</small>
        </div>

        <div class="form-group">
            <label class="form-label">通知渠道</label>
            <div class="checkbox-group">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="info_ch_1" name="info_channels" value="serverchan" {% if 'serverchan' in config.alert_rules.info.channels %}checked{% endif %}>
                    <label for="info_ch_1">Server酱（微信）</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="info_ch_2" name="info_channels" value="webhook" {% if 'webhook' in config.alert_rules.info.channels %}checked{% endif %}>
                    <label for="info_ch_2">Webhook</label>
                </div>
            </div>
        </div>
    </div>

    <!-- 静默时间 -->
    <div class="card">
        <div class="card-header" style="color: var(--gray-600);">
            🌙 静默时间（Do Not Disturb）
        </div>

        <div class="form-group">
            <div class="toggle-wrapper">
                <span class="toggle-label">启用静默时间</span>
                <label class="switch">
                    <input type="checkbox" name="silent_hours_enabled" {% if config.alert_rules.silent_hours.enabled %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </div>
            <small class="form-hint">在指定时间段内不发送告警（避免夜间打扰）</small>
        </div>

        <div class="form-group">
            <label class="form-label">开始时间</label>
            <input type="time" class="form-input" name="silent_start" value="{{ config.alert_rules.silent_hours.start }}">
        </div>

        <div class="form-group">
            <label class="form-label">结束时间</label>
            <input type="time" class="form-input" name="silent_end" value="{{ config.alert_rules.silent_hours.end }}">
            <small class="form-hint">例如：22:00 到 08:00（夜间静默）</small>
        </div>
    </div>

    <div class="flex items-center gap-4 mt-8">
        <button type="submit" class="btn btn-primary">💾 保存告警规则</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">← 返回仪表板</a>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('alertRulesForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    ajaxPost('{{ url_for("alert_rules_config") }}', Object.fromEntries(formData), function(data) {
        if (data.success) {
            alert('✅ ' + data.message);
            setTimeout(function() {
                window.location.reload();
            }, 1000);
        } else {
            alert('❌ ' + data.message);
        }
    });
});
</script>
{% endblock %}

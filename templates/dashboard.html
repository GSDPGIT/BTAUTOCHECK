{% extends "base.html" %}

{% block title %}ä»ªè¡¨æ¿ - BTAUTOCHECK{% endblock %}

{% block content %}
<h2 style="margin-bottom: 2rem;">ğŸ“Š ä»ªè¡¨æ¿</h2>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">å½“å‰ç‰ˆæœ¬</div>
        <div class="stat-value">{{ stats.current_version }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">å®‰å…¨é˜ˆå€¼</div>
        <div class="stat-value">{{ stats.security_threshold }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">å¤‡ä»½æ•°é‡</div>
        <div class="stat-value">{{ stats.backup_count }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">é€šçŸ¥çŠ¶æ€</div>
        <div class="stat-value">
            {% if stats.notification_enabled %}
            <span style="color: #51cf66;">âœ“</span>
            {% else %}
            <span style="color: #ff6b6b;">âœ—</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">â° è‡ªåŠ¨æ£€æµ‹è°ƒåº¦å™¨</div>
    <div id="scheduler-status" style="padding: 1rem;">
        <p>åŠ è½½ä¸­...</p>
    </div>
    <div style="display: flex; gap: 1rem; padding: 0 1rem 1rem 1rem;">
        <button onclick="runCheckNow()" class="btn btn-primary">
            ğŸš€ ç«‹å³æ‰§è¡Œæ£€æµ‹
        </button>
        <button onclick="toggleScheduler()" id="toggleBtn" class="btn btn-secondary">
            â¸ï¸ æš‚åœè°ƒåº¦å™¨
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">å¿«é€Ÿæ“ä½œ</div>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="uploadToGithub()" class="btn btn-primary">
            ğŸ“¤ ä¸Šä¼ æŠ¥å‘Šåˆ°GitHub
        </button>
        <button onclick="testNotification()" class="btn btn-success">
            ğŸ“¨ æµ‹è¯•é€šçŸ¥
        </button>
        <a href="{{ url_for('config_management') }}" class="btn btn-secondary">
            âš™ï¸ é…ç½®ç®¡ç†
        </a>
        <a href="{{ url_for('backup_list') }}" class="btn btn-secondary">
            ğŸ’¾ å¤‡ä»½ç®¡ç†
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">æœ€è¿‘çš„å®‰å…¨æŠ¥å‘Š</div>
    {% if reports %}
    <table>
        <thead>
            <tr>
                <th>æ–‡ä»¶å</th>
                <th>å¤§å°</th>
                <th>ç”Ÿæˆæ—¶é—´</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for report in reports %}
            <tr>
                <td>{{ report.filename }}</td>
                <td>{{ (report.size / 1024) | round(2) }} KB</td>
                <td>{{ report.mtime }}</td>
                <td>
                    <a href="{{ url_for('report_view', filename=report.filename) }}" class="btn btn-primary" style="padding: 0.5rem 1rem;">æŸ¥çœ‹</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #868e96; text-align: center; padding: 2rem;">æš‚æ— æŠ¥å‘Š</p>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">æœ€è¿‘æ—¥å¿—</div>
    <div class="log-viewer">
        <pre>{% for log in logs %}{{ log }}
{% endfor %}</pre>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let schedulerEnabled = true;
let intervalHours = 1;

// åŠ è½½è°ƒåº¦å™¨çŠ¶æ€
function loadSchedulerStatus() {
    fetch('{{ url_for("scheduler_status") }}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                schedulerEnabled = data.enabled;
                intervalHours = data.interval_hours;
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">';
                html += '<div>';
                html += '<strong>çŠ¶æ€:</strong> ';
                html += data.enabled ? '<span style="color: #51cf66;">âœ“ å·²å¯ç”¨</span>' : '<span style="color: #ff6b6b;">âœ— å·²ç¦ç”¨</span>';
                html += '</div>';
                html += '<div><strong>æ£€æµ‹é—´éš”:</strong> ' + data.interval_hours + ' å°æ—¶</div>';
                html += '<div><strong>è°ƒåº¦å™¨è¿è¡Œ:</strong> ' + (data.scheduler_running ? 'âœ“' : 'âœ—') + '</div>';
                html += '</div>';
                
                if (data.jobs && data.jobs.length > 0) {
                    html += '<div style="margin-top: 1rem;"><strong>ä¸‹æ¬¡æ‰§è¡Œ:</strong> ' + data.jobs[0].next_run + '</div>';
                }
                
                document.getElementById('scheduler-status').innerHTML = html;
                
                // æ›´æ–°æŒ‰é’®
                const toggleBtn = document.getElementById('toggleBtn');
                if (data.enabled) {
                    toggleBtn.innerHTML = 'â¸ï¸ æš‚åœè°ƒåº¦å™¨';
                    toggleBtn.className = 'btn btn-warning';
                } else {
                    toggleBtn.innerHTML = 'â–¶ï¸ å¯åŠ¨è°ƒåº¦å™¨';
                    toggleBtn.className = 'btn btn-success';
                }
            }
        });
}

// ç«‹å³æ‰§è¡Œæ£€æµ‹
function runCheckNow() {
    if (!confirm('ç¡®å®šè¦ç«‹å³å¼€å§‹æ£€æµ‹å—ï¼Ÿ\næ£€æµ‹è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
        return;
    }
    
    ajaxPost('{{ url_for("scheduler_run_now") }}', {}, function(data) {
        if (data.success) {
            alert('âœ… ' + data.message);
        } else {
            alert('âŒ ' + data.message);
        }
    });
}

// å¯ç”¨/ç¦ç”¨è°ƒåº¦å™¨
function toggleScheduler() {
    const newState = !schedulerEnabled;
    const action = newState ? 'å¯ç”¨' : 'ç¦ç”¨';
    
    if (!confirm('ç¡®å®šè¦' + action + 'è‡ªåŠ¨æ£€æµ‹è°ƒåº¦å™¨å—ï¼Ÿ')) {
        return;
    }
    
    ajaxPost('{{ url_for("scheduler_toggle") }}', {
        enabled: newState,
        interval_hours: intervalHours
    }, function(data) {
        if (data.success) {
            alert('âœ… ' + data.message);
            loadSchedulerStatus();
        } else {
            alert('âŒ ' + data.message);
        }
    });
}

function uploadToGithub() {
    if (!confirm('ç¡®å®šè¦ä¸Šä¼ æœ€æ–°æŠ¥å‘Šåˆ°GitHubå—ï¼Ÿ\n\nè¯·ç¡®ä¿å·²åœ¨é…ç½®ç®¡ç†ä¸­è®¾ç½®äº†GitHubä¿¡æ¯ã€‚')) {
        return;
    }
    
    ajaxPost('{{ url_for("upload_to_github") }}', {}, function(data) {
        if (data.success) {
            alert('âœ… ' + data.message);
        } else {
            alert('âŒ ' + data.message + '\n\næç¤ºï¼šè¯·å…ˆåœ¨"é…ç½®ç®¡ç†"ä¸­è®¾ç½®GitHubç”¨æˆ·åã€ä»“åº“åå’ŒToken');
        }
    });
}

function testNotification() {
    if (!confirm('ç¡®å®šè¦å‘é€æµ‹è¯•é€šçŸ¥å—ï¼Ÿ')) {
        return;
    }
    
    ajaxPost('{{ url_for("test_notification") }}', {}, function(data) {
        if (data.success) {
            alert('âœ… ' + data.message);
        } else {
            alert('âŒ ' + data.message);
        }
    });
}

// é¡µé¢åŠ è½½æ—¶è·å–è°ƒåº¦å™¨çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    loadSchedulerStatus();
    // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
    setInterval(loadSchedulerStatus, 30000);
});
</script>
{% endblock %}


# 🔄 BTAUTOCHECK 迁移指南

> **从宝塔定时任务迁移到内置调度器**  
> **版本**: V2.0+  
> **更新时间**: 2025-11-03

---

## 📖 背景说明

BTAUTOCHECK V2.0引入了**内置调度器**功能，现在可以直接在Web界面控制自动检测，**无需依赖宝塔面板的定时任务**。

### 为什么要迁移？

| 特性 | 宝塔定时任务 | 内置调度器 ⭐ |
|------|------------|------------|
| **配置难度** | 需要在宝塔面板手动配置 | 自动启用，开箱即用 |
| **灵活性** | 修改需要重新配置 | Web界面一键调整 |
| **控制粒度** | 只能按天 | 按小时（更频繁） |
| **实时控制** | 无法暂停 | 一键启动/暂停 |
| **立即执行** | 无法手动触发 | 一键立即执行 |
| **状态监控** | 无可视化 | 实时状态显示 |
| **Docker支持** | 不支持 | 完美支持 |

---

## 🚀 快速迁移步骤

### 步骤1: 更新到最新版本

```bash
cd ~/BTAUTOCHECK

# 保存本地配置
git stash

# 拉取最新代码
git pull origin main

# 恢复配置
git stash pop

# 更新依赖
pip3 install -r requirements.txt
```

### 步骤2: 删除宝塔定时任务

1. 登录宝塔面板
2. 进入 **计划任务**
3. 找到 `BT面板版本自动检测` 任务
4. 点击 **删除**

⚠️ **重要**: 必须删除宝塔定时任务，否则会与内置调度器重复执行！

### 步骤3: 重启Web服务

```bash
cd ~/BTAUTOCHECK

# 停止旧服务
pkill -f web_admin.py

# 启动新服务（含调度器）
nohup python3 web_admin.py > web.log 2>&1 &

# 查看日志确认调度器已启动
tail -f web.log
```

你应该看到类似输出：

```
✅ 自动检测调度器已启动
⏰ 检测间隔: 1 小时
```

### 步骤4: 验证调度器状态

1. 访问Web界面: `http://你的IP:5000`
2. 进入 **📊 仪表板**
3. 查看 **⏰ 自动检测调度器** 卡片
4. 确认状态显示为 "✓ 已启用"

---

## ⚙️ 配置调度器

### 方式1: Web界面配置（推荐）

1. 访问Web界面仪表板
2. 在 "⏰ 自动检测调度器" 卡片中
3. 点击 **⏸️ 暂停调度器** 或 **▶️ 启动调度器**
4. 点击 **🚀 立即执行检测** 手动触发

### 方式2: 配置文件

编辑 `config.json`:

```json
{
  "scheduler": {
    "enabled": true,         // true=启用, false=禁用
    "interval_hours": 1      // 检测间隔（小时）
  }
}
```

**常用间隔设置**:
- `1` - 每1小时（默认，推荐）
- `2` - 每2小时
- `6` - 每6小时
- `12` - 每12小时
- `24` - 每24小时（相当于宝塔每天一次）

修改后重启Web服务：

```bash
pkill -f web_admin.py
nohup python3 web_admin.py > web.log 2>&1 &
```

---

## 🐳 Docker用户迁移

### 步骤1: 更新Docker镜像

```bash
cd ~/BTAUTOCHECK

# 拉取最新代码
git pull origin main

# 重新构建镜像
docker-compose build --no-cache

# 重启容器
docker-compose up -d --force-recreate
```

### 步骤2: 验证调度器

```bash
# 查看容器日志
docker-compose logs -f

# 应该看到调度器启动信息
# ✅ 自动检测调度器已启动
# ⏰ 检测间隔: 1 小时
```

### 步骤3: 删除宝塔定时任务

同上面的步骤2。

---

## 📊 对比效果

### 迁移前（宝塔定时任务）

```
✗ 每天凌晨3点执行一次
✗ 需要手动修改cron表达式
✗ 无法立即执行
✗ 无可视化状态
✗ Docker环境不可用
```

### 迁移后（内置调度器）

```
✓ 每1小时自动检测（可调整）
✓ Web界面一键控制
✓ 随时立即执行
✓ 实时状态显示
✓ Docker完美支持
✓ 下次执行时间可见
```

---

## 🔧 高级配置

### 调整检测间隔

根据你的需求调整：

| 场景 | 推荐间隔 | 说明 |
|------|---------|------|
| **生产环境** | 1-2小时 | 及时发现新版本 |
| **测试环境** | 6-12小时 | 节省资源 |
| **低频使用** | 24小时 | 每天一次即可 |

### 禁用自动检测

如果只想手动检测：

```json
{
  "scheduler": {
    "enabled": false
  }
}
```

或在Web界面点击 **⏸️ 暂停调度器**。

### 仅在特定时间检测

目前调度器按间隔执行，如需特定时间，请保留宝塔定时任务并禁用内置调度器。

---

## ❓ 常见问题

### Q1: 迁移后宝塔定时任务还在运行？

**A**: 必须手动在宝塔面板删除定时任务。

### Q2: 调度器会自动启动吗？

**A**: 是的，Web服务启动时自动初始化调度器。

### Q3: Docker重启后调度器还在吗？

**A**: 是的，容器重启后自动恢复调度。

### Q4: 可以同时使用宝塔任务和调度器吗？

**A**: 不推荐，会导致重复执行。选择其中一种即可。

### Q5: 调度器会占用很多资源吗？

**A**: 不会，调度器非常轻量，只在触发时执行检测。

### Q6: 如何查看调度器日志？

**A**: 
```bash
# 直接运行的Web服务
tail -f web.log

# Docker运行
docker-compose logs -f
```

### Q7: 调度器执行失败了怎么办？

**A**: 
1. 查看Web日志: `cat web.log`
2. 在Web界面点击 **🚀 立即执行检测**
3. 查看系统日志: `📝 系统日志` 页面

---

## 🆘 回滚方案

如果遇到问题，可以回滚到宝塔定时任务：

### 1. 禁用内置调度器

```json
{
  "scheduler": {
    "enabled": false
  }
}
```

### 2. 重新添加宝塔定时任务

按照 [BT_CRON_SETUP.md](BT_CRON_SETUP.md) 配置。

### 3. 报告问题

在GitHub Issues报告问题：
https://github.com/GSDPGIT/BTAUTOCHECK/issues

---

## ✅ 迁移检查清单

完成以下检查确保迁移成功：

- [ ] 代码已更新到最新版本
- [ ] 依赖已安装 (`pip3 install -r requirements.txt`)
- [ ] 宝塔定时任务已删除
- [ ] Web服务已重启
- [ ] 调度器状态显示 "✓ 已启用"
- [ ] 下次执行时间正常显示
- [ ] 手动执行 "🚀 立即执行检测" 成功
- [ ] 日志正常输出

---

## 📞 获取帮助

- **GitHub**: https://github.com/GSDPGIT/BTAUTOCHECK
- **Issues**: 提交问题和建议
- **文档**: 
  - [README.md](README.md) - 主文档
  - [DOCKER_SETUP.md](DOCKER_SETUP.md) - Docker部署
  - [BT_CRON_SETUP.md](BT_CRON_SETUP.md) - 定时任务（可选）

---

## 🎉 享受新功能

迁移完成后，你将获得：

✅ **更灵活的检测** - 每小时而非每天  
✅ **更好的控制** - Web界面一键操作  
✅ **更佳的体验** - 实时状态可见  
✅ **更强的可靠性** - 自动重启恢复  

**祝使用愉快！** 🚀


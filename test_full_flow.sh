#!/bin/bash
# BT-Panel è‡ªåŠ¨åŒ–ç³»ç»Ÿå®Œæ•´æµç¨‹æµ‹è¯•è„šæœ¬

echo "======================================================================"
echo " ğŸ§ª BTAUTOCHECK å®Œæ•´æµç¨‹æµ‹è¯•"
echo "======================================================================"
echo ""

# ä¿å­˜åŸå§‹é…ç½®
echo "ğŸ“¦ å¤‡ä»½åŸå§‹é…ç½®..."
cp config.json config.json.bak

# ä¿®æ”¹å½“å‰ç‰ˆæœ¬ä¸º11.1.0ï¼ˆæ¨¡æ‹Ÿæ—§ç‰ˆæœ¬ï¼‰
echo "ğŸ”§ æ¨¡æ‹Ÿæ—§ç‰ˆæœ¬ç¯å¢ƒï¼ˆ11.1.0 -> 11.2.0ï¼‰..."
sed -i 's/"current_version": "11.2.0"/"current_version": "11.1.0"/g' config.json

echo ""
echo "======================================================================"
echo " ğŸš€ å¼€å§‹æµ‹è¯•å®Œæ•´æµç¨‹..."
echo "======================================================================"
echo ""

# è¿è¡Œè‡ªåŠ¨æ›´æ–°
python3 auto_update.py

# ä¿å­˜é€€å‡ºç 
EXIT_CODE=$?

echo ""
echo "======================================================================"
echo " ğŸ”„ æ¢å¤åŸå§‹é…ç½®..."
echo "======================================================================"

# æ¢å¤åŸå§‹é…ç½®
mv config.json.bak config.json

echo ""
echo "======================================================================"
echo " ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“"
echo "======================================================================"
echo ""

if [ $EXIT_CODE -eq 0 ]; then
    echo "âœ… æµ‹è¯•æˆåŠŸå®Œæˆï¼"
    echo ""
    echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
    echo ""
    
    # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
    [ -f "new_version.json" ] && echo "  âœ… new_version.json - ç‰ˆæœ¬ä¿¡æ¯"
    [ -f "downloads/LinuxPanel-11.2.0.zip" ] && echo "  âœ… LinuxPanel-11.2.0.zip - ä¸‹è½½çš„å®‰è£…åŒ…"
    [ -f "reports/security_report_11.2.0.md" ] && echo "  âœ… security_report_11.2.0.md - å®‰å…¨æ£€æµ‹æŠ¥å‘Š"
    [ -f "version.json" ] && echo "  âœ… version.json - æ›´æ–°çš„ç‰ˆæœ¬é…ç½®"
    
    echo ""
    echo "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
    echo "  1. æŸ¥çœ‹ç”Ÿæˆçš„å®‰å…¨æ£€æµ‹æŠ¥å‘Š"
    echo "  2. å¦‚æœæ£€æµ‹é€šè¿‡ï¼Œæ¨é€åˆ°GitHubï¼š"
    echo "     git add ."
    echo "     git commit -m 'Auto: Update to version 11.2.0'"
    echo "     git push origin main"
else
    echo "âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼ˆé€€å‡ºç : $EXIT_CODEï¼‰"
    echo ""
    echo "ğŸ” è¯·æ£€æŸ¥ï¼š"
    echo "  - Gemini API Keyæ˜¯å¦é…ç½®æ­£ç¡®"
    echo "  - ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
    echo "  - Pythonä¾èµ–æ˜¯å¦å®‰è£…å®Œæ•´"
fi

echo ""
echo "======================================================================"


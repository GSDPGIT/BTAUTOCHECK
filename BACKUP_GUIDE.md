# ğŸ“¦ å¤‡ä»½å’Œå›æ»šæŒ‡å—

BTAUTOCHECK æä¾›å®Œå–„çš„å¤‡ä»½å’Œå›æ»šæœºåˆ¶ï¼Œç¡®ä¿å‡çº§å®‰å…¨æ— å¿§ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| âœ… è‡ªåŠ¨å¤‡ä»½ | å‡çº§å‰è‡ªåŠ¨åˆ›å»ºå®Œæ•´å¤‡ä»½ |
| âœ… è‡ªåŠ¨å›æ»š | å‡çº§å¤±è´¥è‡ªåŠ¨æ¢å¤åˆ°ä¹‹å‰ç‰ˆæœ¬ |
| âœ… æ‰‹åŠ¨å¤‡ä»½ | éšæ—¶åˆ›å»ºå¤‡ä»½å¿«ç…§ |
| âœ… æ‰‹åŠ¨å›æ»š | å›æ»šåˆ°ä»»æ„å¤‡ä»½ç‰ˆæœ¬ |
| âœ… å®Œæ•´æ€§éªŒè¯ | MD5æ ¡éªŒç¡®ä¿å¤‡ä»½å¯é  |
| âœ… è‡ªåŠ¨æ¸…ç† | è‡ªåŠ¨ä¿ç•™æœ€è¿‘Nä¸ªå¤‡ä»½ |

---

## âš™ï¸ é…ç½®

åœ¨ `config.json` ä¸­é…ç½®å¤‡ä»½é€‰é¡¹ï¼š

```json
{
    "backup_enabled": true,                    // å¯ç”¨å¤‡ä»½åŠŸèƒ½
    "backup_before_upgrade": true,             // å‡çº§å‰è‡ªåŠ¨å¤‡ä»½
    "auto_rollback_on_failure": true,          // å¤±è´¥è‡ªåŠ¨å›æ»š
    "keep_backups": 5                          // ä¿ç•™å¤‡ä»½æ•°é‡
}
```

### é…ç½®è¯´æ˜

- **backup_enabled**: æ€»å¼€å…³ï¼Œå…³é—­åæ‰€æœ‰å¤‡ä»½åŠŸèƒ½ç¦ç”¨
- **backup_before_upgrade**: å‡çº§å‰æ˜¯å¦è‡ªåŠ¨å¤‡ä»½
- **auto_rollback_on_failure**: å‡çº§å¤±è´¥æ˜¯å¦è‡ªåŠ¨å›æ»š
- **keep_backups**: ä¿ç•™æœ€è¿‘å‡ ä¸ªå¤‡ä»½ï¼ˆæ—§çš„è‡ªåŠ¨åˆ é™¤ï¼‰

---

## ğŸ“‹ ä½¿ç”¨æ–¹æ³•

### 1ï¸âƒ£ æŸ¥çœ‹å¤‡ä»½åˆ—è¡¨

```bash
cd ~/BTAUTOCHECK
python3 backup_manager.py list
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
======================================================================
ğŸ“‹ å¤‡ä»½åˆ—è¡¨
======================================================================

[1] panel_backup_11.2.0_20251103_080000.tar.gz
    ç‰ˆæœ¬: 11.2.0
    å¤§å°: 156 MB
    æ—¶é—´: 2025-11-03T08:00:00
    è¯´æ˜: å‡çº§å‰å¤‡ä»½ (11.2.0 -> 11.3.0)

[2] panel_backup_11.1.0_20251101_030000.tar.gz
    ç‰ˆæœ¬: 11.1.0
    å¤§å°: 152 MB
    æ—¶é—´: 2025-11-01T03:00:00
    è¯´æ˜: å®šæœŸå¤‡ä»½

======================================================================
```

### 2ï¸âƒ£ æ‰‹åŠ¨åˆ›å»ºå¤‡ä»½

```bash
python3 backup_manager.py backup --version 11.2.0 --desc "æ‰‹åŠ¨å¤‡ä»½"
```

å¤‡ä»½è¿‡ç¨‹ï¼š
```
======================================================================
ğŸ“¦ åˆ›å»ºå¤‡ä»½
======================================================================
ğŸ“ å¤‡ä»½ç›®æ ‡: /www/server/panel
ğŸ’¾ å¤‡ä»½æ–‡ä»¶: panel_backup_11.2.0_20251103_160530.tar.gz
ğŸ’¿ å¯ç”¨ç©ºé—´: 45 GB
ğŸ”„ æ­£åœ¨å‹ç¼©å¤‡ä»½...
âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸ
ğŸ“Š å¤‡ä»½å¤§å°: 156 MB
ğŸ” MD5æ ¡éªŒ: a1b2c3d4e5f6...
```

### 3ï¸âƒ£ æ¢å¤æŒ‡å®šå¤‡ä»½

#### æ–¹å¼ä¸€ï¼šæŒ‡å®šå¤‡ä»½æ–‡ä»¶
```bash
python3 backup_manager.py restore --file backups/panel_backup_11.2.0_20251103_080000.tar.gz
```

#### æ–¹å¼äºŒï¼šæŒ‡å®šç‰ˆæœ¬å·ï¼ˆè‡ªåŠ¨æŸ¥æ‰¾ï¼‰
```bash
python3 backup_manager.py restore --version 11.2.0
```

#### æ–¹å¼ä¸‰ï¼šæ¢å¤æœ€æ–°å¤‡ä»½
```bash
python3 backup_manager.py restore
```

æ¢å¤è¿‡ç¨‹ï¼š
```
======================================================================
ğŸ“¥ æ¢å¤å¤‡ä»½
======================================================================
ğŸ“ å¤‡ä»½æ–‡ä»¶: backups/panel_backup_11.2.0_20251103_080000.tar.gz
ğŸ” éªŒè¯å¤‡ä»½å®Œæ•´æ€§...
âœ… MD5æ ¡éªŒé€šè¿‡
ğŸ”„ åˆ›å»ºå®‰å…¨å¿«ç…§...
ğŸ“¦ æ­£åœ¨æ¢å¤å¤‡ä»½...
âœ… å¤‡ä»½æ¢å¤æˆåŠŸ
ğŸ§¹ å·²æ¸…ç†ä¸´æ—¶æ–‡ä»¶
ğŸ”„ æ­£åœ¨é‡å¯é¢æ¿æœåŠ¡...
======================================================================
âœ… å›æ»šå®Œæˆ
======================================================================
```

---

## ğŸš€ è‡ªåŠ¨åŒ–æµç¨‹

### å‡çº§æµç¨‹ï¼ˆå¯ç”¨å¤‡ä»½ï¼‰

```
1. æ£€æµ‹æ–°ç‰ˆæœ¬
      â†“
2. ä¸‹è½½å‡çº§åŒ…
      â†“
3. å®‰å…¨æ£€æµ‹
      â†“
4. ã€åˆ›å»ºå¤‡ä»½ã€‘ â† è‡ªåŠ¨æ‰§è¡Œ
      â†“
5. æ‰§è¡Œå‡çº§
      â†“
6. éªŒè¯å‡çº§
      â”œâ”€ æˆåŠŸ â†’ ä¿ç•™å¤‡ä»½
      â””â”€ å¤±è´¥ â†’ ã€è‡ªåŠ¨å›æ»šã€‘
```

### è‡ªåŠ¨å›æ»šæ¡ä»¶

å½“ä»¥ä¸‹æƒ…å†µå‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ»šï¼š

1. âœ… å‡çº§è„šæœ¬æ‰§è¡Œå¤±è´¥
2. âœ… æ–‡ä»¶å¤åˆ¶å‡ºé”™
3. âœ… é¢æ¿æœåŠ¡å¯åŠ¨å¤±è´¥
4. âœ… é¢æ¿æ— æ³•è®¿é—®

---

## ğŸ’¾ å¤‡ä»½å­˜å‚¨

### å­˜å‚¨ä½ç½®

```
BTAUTOCHECK/
â””â”€â”€ backups/
    â”œâ”€â”€ panel_backup_11.2.0_20251103_080000.tar.gz
    â”œâ”€â”€ panel_backup_11.1.0_20251101_030000.tar.gz
    â”œâ”€â”€ panel_backup_11.0.0_20251001_030000.tar.gz
    â””â”€â”€ backup_info.json                        # å¤‡ä»½å…ƒæ•°æ®
```

### å¤‡ä»½å†…å®¹

å¤‡ä»½åŒ…å«å®Œæ•´çš„é¢æ¿ç›®å½• `/www/server/panel/`ï¼š

```
panel/
â”œâ”€â”€ class/          # Pythonç±»æ–‡ä»¶
â”œâ”€â”€ config/         # é…ç½®æ–‡ä»¶
â”œâ”€â”€ data/           # æ•°æ®æ–‡ä»¶
â”œâ”€â”€ logs/           # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ plugin/         # æ’ä»¶
â”œâ”€â”€ static/         # é™æ€èµ„æº
â”œâ”€â”€ vhost/          # è™šæ‹Ÿä¸»æœºé…ç½®
â””â”€â”€ ...
```

### å¤‡ä»½å…ƒæ•°æ®

`backup_info.json` è®°å½•æ‰€æœ‰å¤‡ä»½çš„è¯¦ç»†ä¿¡æ¯ï¼š

```json
{
  "backups": [
    {
      "version": "11.2.0",
      "filename": "panel_backup_11.2.0_20251103_080000.tar.gz",
      "filepath": "backups/panel_backup_11.2.0_20251103_080000.tar.gz",
      "size": 163577856,
      "md5": "a1b2c3d4e5f67890...",
      "timestamp": "20251103_080000",
      "description": "å‡çº§å‰å¤‡ä»½ (11.2.0 -> 11.3.0)",
      "panel_path": "/www/server/panel",
      "created_at": "2025-11-03T08:00:00"
    }
  ]
}
```

---

## ğŸ”§ é«˜çº§æ“ä½œ

### 1. ä¿®æ”¹å¤‡ä»½ä¿ç•™æ•°é‡

ç¼–è¾‘ `config.json`ï¼š
```json
"keep_backups": 10  // ä¿ç•™10ä¸ªå¤‡ä»½
```

### 2. æ‰‹åŠ¨æ¸…ç†æ‰€æœ‰å¤‡ä»½

```bash
rm -rf ~/BTAUTOCHECK/backups/*
```

### 3. å¯¼å‡ºå¤‡ä»½åˆ°å…¶ä»–æœåŠ¡å™¨

```bash
# å‹ç¼©å¤‡ä»½ç›®å½•
cd ~/BTAUTOCHECK
tar -czf btautocheck_backups.tar.gz backups/

# ä¼ è¾“åˆ°å…¶ä»–æœåŠ¡å™¨
scp btautocheck_backups.tar.gz user@remote:/path/

# åœ¨ç›®æ ‡æœåŠ¡å™¨è§£å‹
tar -xzf btautocheck_backups.tar.gz
```

### 4. éªŒè¯å¤‡ä»½å®Œæ•´æ€§

```bash
cd ~/BTAUTOCHECK
python3 << 'EOF'
from backup_manager import BackupManager
manager = BackupManager()
backups = manager.list_backups()
for backup in backups:
    filepath = backup['filepath']
    result = manager._verify_backup(filepath)
    print(f"{backup['filename']}: {'âœ… å®Œæ•´' if result else 'âŒ æŸå'}")
EOF
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç£ç›˜ç©ºé—´

å¤‡ä»½éœ€è¦è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼š

- å•ä¸ªå¤‡ä»½çº¦ 150-200 MBï¼ˆå–å†³äºé¢æ¿é…ç½®ï¼‰
- ä¿ç•™5ä¸ªå¤‡ä»½çº¦éœ€ 750-1000 MB
- å»ºè®®ä¿ç•™è‡³å°‘ 5 GB å¯ç”¨ç©ºé—´

### 2. å¤‡ä»½æ—¶é—´

- åˆ›å»ºå¤‡ä»½é€šå¸¸éœ€è¦ 10-30 ç§’
- æ¢å¤å¤‡ä»½é€šå¸¸éœ€è¦ 20-60 ç§’
- æ—¶é—´å–å†³äºç£ç›˜I/Oæ€§èƒ½

### 3. æ•°æ®ä¸€è‡´æ€§

å¤‡ä»½ä¼šå®Œæ•´ä¿å­˜ï¼š
- âœ… é¢æ¿é…ç½®
- âœ… ç½‘ç«™é…ç½®
- âœ… æ•°æ®åº“é…ç½®
- âœ… SSLè¯ä¹¦
- âœ… ç”¨æˆ·æ•°æ®

ä½†ä¸åŒ…æ‹¬ï¼š
- âŒ å®é™…ç½‘ç«™æ–‡ä»¶ï¼ˆ/www/wwwroot/ï¼‰
- âŒ MySQLæ•°æ®åº“å†…å®¹
- âŒ ç³»ç»ŸæœåŠ¡é…ç½®ï¼ˆNginx/PHPç­‰ï¼‰

### 4. æƒé™é—®é¢˜

å¤‡ä»½å’Œæ¢å¤æ“ä½œéœ€è¦rootæƒé™ï¼š

```bash
sudo python3 backup_manager.py backup --version 11.2.0
```

---

## ğŸ†˜ æ•…éšœæ’é™¤

### Q1: å¤‡ä»½å¤±è´¥ - ç£ç›˜ç©ºé—´ä¸è¶³

**é—®é¢˜**ï¼š
```
âŒ å¤‡ä»½åˆ›å»ºå¤±è´¥: [Errno 28] No space left on device
```

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ¸…ç†æ—§å¤‡ä»½
cd ~/BTAUTOCHECK/backups
rm panel_backup_*.tar.gz

# æˆ–æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶
sudo apt clean  # Debian/Ubuntu
sudo yum clean all  # CentOS/RHEL
```

### Q2: æ¢å¤å¤±è´¥ - å¤‡ä»½æ–‡ä»¶æŸå

**é—®é¢˜**ï¼š
```
âŒ MD5æ ¡éªŒå¤±è´¥
```

**è§£å†³**ï¼š
```bash
# å°è¯•æ¢å¤å…¶ä»–å¤‡ä»½
python3 backup_manager.py list
python3 backup_manager.py restore --version 11.1.0
```

### Q3: é¢æ¿æ— æ³•å¯åŠ¨

**é—®é¢˜**ï¼šæ¢å¤å¤‡ä»½åé¢æ¿ä»æ— æ³•å¯åŠ¨

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥é¢æ¿æœåŠ¡
bt status

# æ‰‹åŠ¨é‡å¯
bt restart

# æŸ¥çœ‹æ—¥å¿—
tail -f /www/server/panel/logs/error.log

# å¦‚æœä»æœ‰é—®é¢˜ï¼Œé‡æ–°å®‰è£…é¢æ¿ï¼ˆä¼šä¸¢å¤±é…ç½®ï¼‰
curl https://download.bt.cn/install/install_panel.sh|bash
```

### Q4: è‡ªåŠ¨å›æ»šæœªæ‰§è¡Œ

**é—®é¢˜**ï¼šå‡çº§å¤±è´¥ä½†æ²¡æœ‰è‡ªåŠ¨å›æ»š

**æ£€æŸ¥é…ç½®**ï¼š
```json
{
    "backup_before_upgrade": true,         // å¿…é¡»ä¸ºtrue
    "auto_rollback_on_failure": true       // å¿…é¡»ä¸ºtrue
}
```

**æ‰‹åŠ¨å›æ»š**ï¼š
```bash
python3 backup_manager.py restore
```

---

## âœ… æœ€ä½³å®è·µ

### 1. å®šæœŸæ‰‹åŠ¨å¤‡ä»½

å»ºè®®åœ¨ä»¥ä¸‹æƒ…å†µæ‰‹åŠ¨å¤‡ä»½ï¼š

- ğŸ”¹ ä¿®æ”¹é‡è¦é…ç½®å‰
- ğŸ”¹ å®‰è£…æ–°æ’ä»¶å‰
- ğŸ”¹ å¤§ç‰ˆæœ¬å‡çº§å‰
- ğŸ”¹ æ¯æœˆå®šæœŸå¤‡ä»½

### 2. æµ‹è¯•æ¢å¤æµç¨‹

å»ºè®®å®šæœŸæµ‹è¯•å¤‡ä»½æ¢å¤ï¼š

```bash
# 1. åˆ›å»ºæµ‹è¯•å¤‡ä»½
python3 backup_manager.py backup --version $(bt version) --desc "æµ‹è¯•å¤‡ä»½"

# 2. è®°å½•å½“å‰çŠ¶æ€
ls /www/server/panel > before.txt

# 3. æ¢å¤å¤‡ä»½
python3 backup_manager.py restore

# 4. éªŒè¯æ¢å¤
ls /www/server/panel > after.txt
diff before.txt after.txt
```

### 3. å¼‚åœ°å¤‡ä»½

å°†å¤‡ä»½å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨æˆ–äº‘å­˜å‚¨ï¼š

```bash
# åŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨
rsync -avz ~/BTAUTOCHECK/backups/ user@backup-server:/backups/bt-panel/

# æˆ–ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆéœ€è¦é…ç½®å·¥å…·ï¼‰
rclone sync ~/BTAUTOCHECK/backups/ remote:bt-panel-backups/
```

### 4. ç›‘æ§å¤‡ä»½çŠ¶æ€

å®šæœŸæ£€æŸ¥å¤‡ä»½æ˜¯å¦æ­£å¸¸ï¼š

```bash
# æŸ¥çœ‹æœ€è¿‘å¤‡ä»½
python3 backup_manager.py list | head -20

# éªŒè¯æœ€æ–°å¤‡ä»½
python3 << 'EOF'
from backup_manager import BackupManager
manager = BackupManager()
backup_file = manager._get_latest_backup()
if backup_file and manager._verify_backup(backup_file):
    print("âœ… æœ€æ–°å¤‡ä»½æ­£å¸¸")
else:
    print("âŒ å¤‡ä»½å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ï¼")
EOF
```

---

## ğŸ“Š å¤‡ä»½ç­–ç•¥å»ºè®®

### æ–¹æ¡ˆä¸€ï¼šä¿å®ˆå‹ï¼ˆæ¨èï¼‰

```json
{
    "backup_before_upgrade": true,
    "auto_rollback_on_failure": true,
    "keep_backups": 10
}
```

- âœ… å‡çº§å‰å¿…å¤‡ä»½
- âœ… å¤±è´¥è‡ªåŠ¨å›æ»š
- âœ… ä¿ç•™10ä¸ªå¤‡ä»½ï¼ˆçº¦2GBï¼‰

### æ–¹æ¡ˆäºŒï¼šæ¿€è¿›å‹

```json
{
    "backup_before_upgrade": true,
    "auto_rollback_on_failure": false,
    "keep_backups": 3
}
```

- âœ… å‡çº§å‰å¤‡ä»½
- âŒ ä¸è‡ªåŠ¨å›æ»šï¼ˆæ‰‹åŠ¨å¤„ç†ï¼‰
- âœ… åªä¿ç•™3ä¸ªå¤‡ä»½ï¼ˆèŠ‚çœç©ºé—´ï¼‰

### æ–¹æ¡ˆä¸‰ï¼šæç®€å‹ï¼ˆä¸æ¨èï¼‰

```json
{
    "backup_before_upgrade": false,
    "auto_rollback_on_failure": false,
    "keep_backups": 0
}
```

- âŒ ä¸å¤‡ä»½ï¼ˆé£é™©å¤§ï¼‰
- âŒ ä¸å›æ»š
- âš ï¸  ä»…ç”¨äºæµ‹è¯•ç¯å¢ƒ

---

**å¤‡ä»½åŠŸèƒ½é…ç½®å®Œæˆï¼** ğŸ‰

ç°åœ¨æ‚¨çš„é¢æ¿å‡çº§æœ‰äº†å®Œå–„çš„å®‰å…¨ä¿éšœï¼


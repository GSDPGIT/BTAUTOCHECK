# 🎉 BTAUTOCHECK V2.1 新功能说明

> **版本**: V2.1  
> **发布日期**: 2025-11-03  
> **更新内容**: 调度器配置、GitHub上传、报告列表修复

---

## 📋 用户反馈的问题

### 问题1: 报告列表只显示一个 ✅ 已修复

**问题描述**: 安全报告列表只显示一个报告，历史报告看不到

**原因分析**: 文件名匹配模式可能存在大小写问题

**解决方案**:
- 支持多种文件名格式匹配：
  - `SECURITY_REPORT_*.md`
  - `Security_Report_*.md`
  - `security_report_*.md`
- 自动去重并按时间倒序排列
- 显示版本号方便识别

**使用方式**:
1. 访问Web界面
2. 进入 **📋 安全报告**
3. 现在可以看到所有历史报告

---

### 问题2: 无法修改调度器配置 ✅ 已添加

**问题描述**: 默认每1小时检测一次，想改成每天一次但不知道在哪里配置

**解决方案**: 在Web界面添加了完整的调度器配置

**配置位置**: **⚙️ 配置管理** → **⏰ 自动检测调度器**

**可配置选项**:
| 选项 | 说明 | 可选值 |
|------|------|--------|
| **启用自动检测** | 开关调度器 | 开/关 |
| **检测间隔** | 自动检测频率 | 1/2/3/6/12/24 小时 |

**使用步骤**:
1. 访问Web界面
2. 进入 **⚙️ 配置管理**
3. 找到 **⏰ 自动检测调度器** 部分
4. 选择检测间隔（如24小时=每天一次）
5. 点击 **💾 保存配置**
6. 调度器会自动重新初始化

**推荐设置**:
- **生产环境**: 1-2小时（及时发现新版本）
- **测试环境**: 6-12小时（节省资源）
- **低频使用**: 24小时（每天一次）

**关闭自动检测**:
- 取消勾选 "启用自动检测"
- 仍可使用 **🚀 立即执行检测** 按钮手动触发

---

### 问题3: 无法配置GitHub上传 ✅ 已添加

**问题描述**: 检测完想上传到GitHub但后台没有配置选项

**解决方案**: 添加了完整的GitHub配置和手动上传功能

**配置位置**: **⚙️ 配置管理** → **📦 GitHub上传配置**

**可配置选项**:
| 选项 | 说明 | 必填 |
|------|------|------|
| **启用自动上传** | 检测完成后自动上传 | 否 |
| **GitHub用户名** | 你的GitHub用户名 | 是 |
| **GitHub仓库名** | 存放报告的仓库 | 是 |
| **GitHub Token** | Personal Access Token | 是 |

**使用步骤**:

#### 1. 获取GitHub Token

1. 访问 https://github.com/settings/tokens
2. 点击 **Generate new token (classic)**
3. 设置Token名称：`BTAUTOCHECK`
4. 勾选权限：**repo** (完整仓库权限)
5. 点击 **Generate token**
6. **复制Token**（只显示一次！）

#### 2. 配置BTAUTOCHECK

1. 访问Web界面
2. 进入 **⚙️ 配置管理**
3. 找到 **📦 GitHub上传配置** 部分
4. 填写：
   - GitHub用户名：`your_username`
   - GitHub仓库名：`bt-panel-files`（或你的仓库名）
   - GitHub Token：粘贴刚才复制的Token
5. （可选）勾选 **启用自动上传**
6. 点击 **💾 保存配置**

#### 3. 手动上传报告

1. 访问Web界面仪表板
2. 点击 **📤 上传报告到GitHub** 按钮
3. 确认上传
4. 等待上传完成
5. 访问你的GitHub仓库查看报告

**自动上传**:
- 勾选 "启用自动上传"
- 每次检测完成后自动上传到GitHub
- 无需手动操作

---

## 🆕 新增功能清单

### 1. ⏰ 调度器Web配置

| 功能 | 说明 |
|------|------|
| ✅ **启用/禁用开关** | 一键控制自动检测 |
| ✅ **间隔时间选择** | 1-24小时，6个选项 |
| ✅ **实时生效** | 保存后立即重新初始化调度器 |
| ✅ **配置持久化** | 保存到config.json |

### 2. 📦 GitHub上传配置

| 功能 | 说明 |
|------|------|
| ✅ **GitHub账号配置** | 用户名、仓库名、Token |
| ✅ **自动上传开关** | 检测完自动上传 |
| ✅ **手动上传按钮** | 仪表板一键上传 |
| ✅ **Token安全输入** | 密码框保护 |
| ✅ **配置验证** | 上传前检查配置完整性 |

### 3. 🔧 报告列表修复

| 改进 | 说明 |
|------|------|
| ✅ **多格式支持** | 支持不同大小写格式 |
| ✅ **显示所有报告** | 不再只显示一个 |
| ✅ **版本号提取** | 清晰显示版本 |
| ✅ **时间倒序** | 最新报告在前 |

---

## 📊 使用场景

### 场景1: 每天检测一次（替代宝塔定时任务）

1. 进入 **⚙️ 配置管理**
2. 调度器设置：
   - 启用自动检测：✓
   - 检测间隔：24小时
3. 保存配置
4. **删除宝塔面板的定时任务**（避免重复）

### 场景2: 频繁检测（生产环境）

1. 进入 **⚙️ 配置管理**
2. 调度器设置：
   - 启用自动检测：✓
   - 检测间隔：1小时
3. 保存配置
4. 系统将每小时自动检测

### 场景3: 手动检测 + 自动上传

1. 进入 **⚙️ 配置管理**
2. 调度器设置：
   - 启用自动检测：✗ (关闭)
3. GitHub设置：
   - 配置GitHub信息
   - 启用自动上传：✓
4. 保存配置
5. 需要时在仪表板点击 **🚀 立即执行检测**
6. 完成后自动上传到GitHub

### 场景4: 手动控制一切

1. 进入 **⚙️ 配置管理**
2. 调度器设置：
   - 启用自动检测：✗
3. GitHub设置：
   - 配置GitHub信息
   - 启用自动上传：✗
4. 保存配置
5. 手动操作：
   - **🚀 立即执行检测** → 执行检测
   - **📤 上传报告到GitHub** → 上传报告

---

## 🎯 完整工作流程

### 推荐流程：全自动

```
1. 配置调度器（每X小时）
      ↓
2. 配置GitHub信息
      ↓
3. 启用自动上传
      ↓
4. 保存配置
      ↓
5. 系统自动运行：
   - 定时检测新版本
   - 生成安全报告
   - 自动上传到GitHub
   - 发送通知（如已配置）
```

### 手动流程：完全控制

```
1. 关闭调度器
      ↓
2. 配置GitHub信息
      ↓
3. 关闭自动上传
      ↓
4. 需要时手动操作：
   - 点击"立即执行检测"
   - 查看报告
   - 确认无误后点击"上传到GitHub"
```

---

## 📱 Web界面导航

```
BTAUTOCHECK Web界面
│
├── 📊 仪表板
│   ├── ⏰ 自动检测调度器（状态显示）
│   │   ├── 🚀 立即执行检测
│   │   └── ⏸️ 暂停/启动调度器
│   ├── 📤 上传报告到GitHub  <--- 新增
│   ├── 📨 测试通知
│   └── 最近的安全报告
│
├── ⚙️ 配置管理
│   ├── 基础配置
│   ├── ⏰ 自动检测调度器  <--- 新增
│   │   ├── 启用自动检测（开关）
│   │   └── 检测间隔（1-24小时）
│   ├── 📦 GitHub上传配置  <--- 新增
│   │   ├── 启用自动上传
│   │   ├── GitHub用户名
│   │   ├── GitHub仓库名
│   │   └── GitHub Token
│   ├── 备份配置
│   ├── 通知配置
│   └── AI配置
│
├── 📋 安全报告  <--- 已修复
│   └── 显示所有历史报告
│
└── 其他功能...
```

---

## 🆙 更新指南

### 已有用户更新

在**Linux服务器**执行：

```bash
cd ~/BTAUTOCHECK

# 1. 保存配置
git stash

# 2. 拉取更新
git pull origin main

# 3. 恢复配置
git stash pop

# 4. 重启Web服务
pkill -f web_admin.py
nohup python3 web_admin.py > web.log 2>&1 &

# 5. 访问Web界面
echo "访问: http://$(hostname -I | awk '{print $1}'):5000"
```

### 验证更新

1. 访问Web界面
2. 进入 **⚙️ 配置管理**
3. 确认可以看到：
   - ⏰ 自动检测调度器
   - 📦 GitHub上传配置
4. 进入 **📋 安全报告**
5. 确认可以看到所有历史报告

---

## ❓ 常见问题

### Q1: 找不到调度器配置？

**A**: 确保已更新到V2.1版本，进入 **⚙️ 配置管理** 应该能看到 "⏰ 自动检测调度器" 部分。

### Q2: 上传GitHub失败？

**A**: 检查：
1. GitHub Token是否正确（需要repo权限）
2. 用户名和仓库名是否正确
3. 仓库是否存在且有写入权限
4. 网络是否能访问GitHub

### Q3: 修改调度器配置后没生效？

**A**: 点击"保存配置"后会自动重新初始化调度器。如果还是不生效，重启Web服务：
```bash
pkill -f web_admin.py
nohup python3 web_admin.py > web.log 2>&1 &
```

### Q4: 仍然只显示一个报告？

**A**: 
1. 确认downloads目录下有多个`.md`报告文件
2. 检查文件名格式是否为`SECURITY_REPORT_*.md`
3. 刷新浏览器页面（Ctrl+F5）

### Q5: 能同时使用宝塔定时任务和内置调度器吗？

**A**: 不推荐，会导致重复执行。建议：
- 使用内置调度器：删除宝塔定时任务
- 使用宝塔任务：关闭内置调度器

---

## 📊 版本对比

| 功能 | V2.0 | V2.1 |
|------|------|------|
| 调度器配置 | 仅config.json | ✅ **Web界面** |
| GitHub配置 | 仅config.json | ✅ **Web界面** |
| 手动上传 | 命令行 | ✅ **一键按钮** |
| 报告列表 | 可能有问题 | ✅ **已修复** |
| 配置验证 | 无 | ✅ **有提示** |

---

## 🎊 总结

**V2.1版本完成了完全的Web界面化管理**，用户无需再手动编辑`config.json`或使用命令行，所有功能都可以通过Web界面轻松配置和操作。

### 核心改进

✅ **调度器可视化配置** - 间隔时间、启用/禁用一目了然  
✅ **GitHub完整配置** - 账号、仓库、Token、上传开关  
✅ **一键手动上传** - 无需命令行，点击即可  
✅ **报告列表修复** - 显示所有历史报告  
✅ **配置即时生效** - 保存后自动重启调度器  

---

**🚀 享受BTAUTOCHECK V2.1带来的便利！**

